<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de Mercado - Melhor Momento para Comprar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Inclusão das bibliotecas de gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/build/chartjs-chart-financial.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para o spinner/loader */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-6 md:p-8">
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Analisador de Ações</h1>
            <p class="text-gray-500 mt-2">Descubra o melhor momento para comprar com base em análise técnica.</p>
        </div>

        <!-- Input Section -->
        <div class="mt-8 space-y-4">
            <div>
                <label for="tickerInput" class="text-sm font-medium text-gray-700">Código da Ação (B3)</label>
                <input type="text" id="tickerInput" placeholder="Ex: PETR4, VALE3, MGLU3" class="mt-1 flex-grow block w-full px-4 py-3 text-gray-900 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            </div>
             <!-- Botões de Ação -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                 <button id="startButton" class="w-full px-5 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                    ▶ Iniciar Monitoramento
                </button>
                <button id="stopButton" class="w-full px-5 py-3 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out" disabled>
                    ■ Parar Monitoramento
                </button>
            </div>
        </div>
        
        <!-- Status Section -->
        <div id="monitoringStatus" class="mt-4 text-center text-sm text-gray-600 bg-gray-100 p-3 rounded-lg hidden"></div>

        <!-- Loader -->
        <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto my-6 hidden"></div>
        
        <!-- Chart Section -->
        <div class="mt-6 hidden" id="chartContainer">
            <canvas id="stockChart"></canvas>
        </div>

        <!-- Result Section -->
        <div id="result" class="mt-6 hidden">
            <!-- O conteúdo será inserido via JavaScript -->
        </div>
    </div>

    <!-- Disclaimer -->
    <div class="w-full max-w-lg text-center mt-6">
        <p class="text-xs text-gray-500">
            <strong>⚠️ AVISO LEGAL:</strong> Esta ferramenta é para fins educacionais e de estudo. Os resultados são gerados por algoritmos baseados em indicadores técnicos e não constituem uma recomendação de investimento. Investir em ações envolve riscos. Faça sua própria análise antes de tomar qualquer decisão financeira.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DA PÁGINA ---
            const tickerInput = document.getElementById('tickerInput');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const resultDiv = document.getElementById('result');
            const loader = document.getElementById('loader');
            const statusDiv = document.getElementById('monitoringStatus');
            const chartContainer = document.getElementById('chartContainer');
            const chartCanvas = document.getElementById('stockChart');

            // --- CONFIGURAÇÃO PRINCIPAL ---
            // IMPORTANTE: Cole seu token da API Brapi aqui, no lugar de "SEU_TOKEN_AQUI"
            const apiToken = "SEU_TOKEN_AQUI";

            // --- VARIÁVEIS DE CONTROLE ---
            let monitoringIntervalId = null;
            let countdownIntervalId = null;
            let stockChart = null;

            // --- EVENT LISTENERS ---
            startButton.addEventListener('click', startMonitoring);
            stopButton.addEventListener('click', stopMonitoring);

            function playAlertSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }

            function startMonitoring() {
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker) {
                    alert('Por favor, digite o código de uma ação para monitorar.');
                    return;
                }
                if (apiToken === "SEU_TOKEN_AQUI" || apiToken === "") {
                    alert('Por favor, insira seu token da API Brapi diretamente no código HTML.');
                    return;
                }

                if (monitoringIntervalId) clearInterval(monitoringIntervalId);
                if (countdownIntervalId) clearInterval(countdownIntervalId);
                if (stockChart) stockChart.destroy();

                startButton.disabled = true;
                stopButton.disabled = false;
                
                analyzeTicker();

                const checkIntervalSeconds = 60;
                monitoringIntervalId = setInterval(analyzeTicker, checkIntervalSeconds * 1000);
                
                updateStatus(checkIntervalSeconds);
            }

            function stopMonitoring() {
                if (monitoringIntervalId) clearInterval(monitoringIntervalId);
                if (countdownIntervalId) clearInterval(countdownIntervalId);
                if (stockChart) {
                    stockChart.destroy();
                    stockChart = null;
                }
                
                monitoringIntervalId = null;
                countdownIntervalId = null;
                
                statusDiv.innerHTML = 'Monitoramento parado.';
                chartContainer.style.display = 'none';
                startButton.disabled = false;
                stopButton.disabled = true;
            }

            function updateStatus(seconds) {
                statusDiv.style.display = 'block';
                let remaining = seconds;
                const updateCountdown = () => {
                    statusDiv.innerHTML = `Monitoramento ativo para <strong>${tickerInput.value.toUpperCase()}</strong>. Próxima verificação em <strong>${remaining}</strong> segundos...`;
                    remaining--;
                    if (remaining < 0) remaining = seconds - 1;
                };
                updateCountdown();
                countdownIntervalId = setInterval(updateCountdown, 1000);
            }

            async function analyzeTicker() {
                const ticker = tickerInput.value.trim().toUpperCase();
                if (!ticker) {
                    if (monitoringIntervalId) stopMonitoring();
                    return;
                }

                loader.style.display = 'block';
                resultDiv.style.display = 'none';
                chartContainer.style.display = 'none';

                try {
                    const apiUrl = `https://brapi.dev/api/quote/${ticker}?range=3mo&interval=1d&fundamental=true&token=${apiToken}`;
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.message || `Erro ${response.status}. Verifique o código da ação e seu token.`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    const stockData = data.results[0];
                    const historicalData = stockData.historicalDataPrice;

                    if (!historicalData || historicalData.length < 22) {
                         throw new Error('Dados históricos insuficientes para uma análise completa.');
                    }
                    
                    const closingPrices = historicalData.map(item => item.close);
                    const rsi = calculateRSI(closingPrices);
                    const sma21 = calculateSMA(closingPrices, 21);
                    
                    // Filtra os dados para mostrar apenas os últimos 30 dias no gráfico
                    const last30DaysData = historicalData.slice(-30);
                    createOrUpdateChart(last30DaysData);
                    
                    displayResult(stockData, rsi, sma21);

                } catch (error) {
                    displayError(error.message);
                    if (monitoringIntervalId) stopMonitoring();
                } finally {
                    loader.style.display = 'none';
                }
            }

            function createOrUpdateChart(chartData) {
                chartContainer.style.display = 'block';
                
                const dataPoints = chartData.map(data => ({
                    x: new Date(data.date * 1000).valueOf(),
                    o: data.open,
                    h: data.high,
                    l: data.low,
                    c: data.close
                }));

                const data = {
                    datasets: [{
                        label: `Preço (OHLC)`,
                        data: dataPoints,
                    }]
                };

                const config = {
                    type: 'candlestick',
                    data: data,
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value, index, values) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const raw = context.raw;
                                        return `Abertura: ${raw.o.toFixed(2)} Máxima: ${raw.h.toFixed(2)} Mínima: ${raw.l.toFixed(2)} Fechamento: ${raw.c.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    }
                };
                
                if (stockChart) {
                    stockChart.data.datasets[0].data = dataPoints;
                    stockChart.update();
                } else {
                    stockChart = new Chart(chartCanvas, config);
                }
            }
            
            function calculateRSI(prices, period = 14) {
                let gains = 0, losses = 0;
                for (let i = 1; i <= period; i++) {
                    const difference = prices[i] - prices[i - 1];
                    if (difference >= 0) gains += difference;
                    else losses -= difference;
                }
                let avgGain = gains / period, avgLoss = losses / period;
                for (let i = period + 1; i < prices.length; i++) {
                    const difference = prices[i] - prices[i - 1];
                    if (difference >= 0) {
                        avgGain = (avgGain * (period - 1) + difference) / period;
                        avgLoss = (avgLoss * (period - 1)) / period;
                    } else {
                        avgGain = (avgGain * (period - 1)) / period;
                        avgLoss = (avgLoss * (period - 1) - difference) / period;
                    }
                }
                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                return 100 - (100 / (1 + rs));
            }

            function calculateSMA(prices, period) {
                const recentPrices = prices.slice(prices.length - period);
                const sum = recentPrices.reduce((a, b) => a + b, 0);
                return sum / period;
            }

            function displayError(message) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"><p class="font-bold">Erro na Análise</p><p>${message}</p></div>`;
            }

            function displayResult(stock, rsi, sma21) {
                resultDiv.style.display = 'block';
                const currentPrice = stock.regularMarketPrice;
                let signalClass, signalTitle, signalDescription;

                if (rsi < 35 && currentPrice > sma21) {
                    signalClass = 'bg-green-100 border-green-500 text-green-800';
                    signalTitle = 'Sinal de Compra Forte';
                    signalDescription = 'A ação está em nível de sobrevenda (IFR baixo) e acima de sua média de curto prazo (MMS 21), indicando uma possível reversão para alta. Pode ser um bom momento para compra.';
                    playAlertSound();
                } else if (rsi > 70) {
                    signalClass = 'bg-red-100 border-red-500 text-red-800';
                    signalTitle = 'Sinal de Cautela (Sobrecompra)';
                    signalDescription = 'O IFR elevado sugere que a ação subiu muito rapidamente e pode estar supervalorizada no curto prazo. O risco de uma correção (queda) é maior.';
                } else {
                    signalClass = 'bg-yellow-100 border-yellow-500 text-yellow-800';
                    signalTitle = 'Sinal Neutro';
                    signalDescription = 'A ação não apresenta sinais claros de sobrecompra ou sobrevenda no momento. Recomenda-se aguardar por um sinal mais definido.';
                }

                resultDiv.innerHTML = `
                    <div class="border-l-4 p-4 rounded-lg ${signalClass}">
                        <div class="flex items-center mb-4">
                            <img src="${stock.logourl}" alt="Logo da empresa" class="w-12 h-12 mr-4 rounded-full" onerror="this.style.display='none'">
                            <div>
                                <h2 class="text-xl font-bold">${stock.symbol} - ${stock.longName}</h2>
                                <p class="text-2xl font-bold">R$ ${currentPrice.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="space-y-3 text-sm">
                            <p><strong>Diagnóstico:</strong> <span class="font-semibold">${signalTitle}</span></p>
                            <p>${signalDescription}</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-300/50 grid grid-cols-2 gap-4 text-sm">
                            <div><p class="font-semibold">Índice de Força Relativa (IFR 14)</p><p class="text-lg font-bold">${rsi.toFixed(2)}</p></div>
                            <div><p class="font-semibold">Média Móvel (MMS 21)</p><p class="text-lg font-bold">R$ ${sma21.toFixed(2)}</p></div>
                        </div>
                    </div>`;
            }
        });
    </script>

</body>
</html>
